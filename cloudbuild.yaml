steps:
  # 1. Build Container Image
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "asia-southeast2-docker.pkg.dev/golden-tenure-478707-e8/diabetes-repo/web-app",
        ".",
      ]

  # 2. Push Image ke Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "asia-southeast2-docker.pkg.dev/golden-tenure-478707-e8/diabetes-repo/web-app",
      ]

  # 3. Deploy ke Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "diabetes-service"
      - "--image"
      - "asia-southeast2-docker.pkg.dev/golden-tenure-478707-e8/diabetes-repo/web-app"
      - "--region"
      - "asia-southeast2"
      - "--allow-unauthenticated" # Agar bisa diakses publik
      - "--add-cloudsql-instances"
      - "[golden-tenure-478707-e8:asia-southeast2:diabetes-db-instance]" # GANTI DENGAN CONNECTION NAME DARI LANGKAH 2
      - "--set-secrets"
      - "DB_USER=DB_USER:latest,DB_PASS=DB_PASS:latest,DB_NAME=DB_NAME:latest,INSTANCE_CONNECTION_NAME=INSTANCE_CONNECTION_NAME:latest,SECRET_KEY=SECRET_KEY:latest"
      - "--set-env-vars"
      - "DATABASE_URL=mysql+pymysql://$(DB_USER):$(DB_PASS)@/$(DB_NAME)?unix_socket=/cloudsql/$(INSTANCE_CONNECTION_NAME)"

images:
  - "asia-southeast2-docker.pkg.dev/golden-tenure-478707-e8/diabetes-repo/web-app"

options:
  logging: CLOUD_LOGGING_ONLY
